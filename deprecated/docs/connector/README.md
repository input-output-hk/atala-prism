# GEUD Proposal - Connector

Connector is a part of GEUD system allowing asynchronous communication between participants - Holders, Issuers, and Verifiers - who don't need to be online all the time.

## Definitions

* **Verifiable Credential** - electronic document containing some statements assured to be true, that is possible to verify automatically, without human interaction
* **Issuer** - entity creating Verifiable Credentials
* **Verifier** - entity that checks validity of Verifiable Credential sent by Holder
* **Holder** - person who receives Verifiable Credentials from Issuers and sends them to Verifiers, utilizing previously insantiated connections
* **Connection** - bidirectional channel between two participants of the system used to send messages to each other
* **Connection Token** - sequence of characters generated by Connector on request by one participant (most often Issuer or Holder) that can be used by another participant (Holder) to instantiate a connection between them.

## Starting Connector

First you need to provide database, which is easiest to do with Docker.
```
docker run -it --rm -e POSTGRES_DB=connector_db -p 5432:5432 postgres
```

Now we can start the connector itself. We're going to need [sbt](https://www.scala-sbt.org) for that.
```
sbt connector/run
```

## Simple issuer and student flow

For testing purposes there are two participants automatically created in the database:
* Issuer with participant id `c8834532-eade-11e9-a88d-d8f2ca059830`,
* Holder with participant id `e20a974e-eade-11e9-a447-d8f2ca059830"`.

We are going to run simple flow, creating connection between them and sending a message over it. All steps should be run inside of `prism-sdk` subdirectory (or protobuf definitions path should be changed).

0. Install grpcurl: https://github.com/fullstorydev/grpcurl (`go install github.com/fullstorydev/grpcurl/cmd/grpcurl`, might involve adding `$HOME/go/bin` to `PATH`).

1. As the issuer generate connection token:
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: c8834532-eade-11e9-a88d-d8f2ca059830" \
 -plaintext localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/GenerateConnectionToken
```

```
{
  "token": "0Am0JpyQi8GqUKL0dZeubw=="
}
```

2. As the user query the token information (insert `token` from step 1):
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: e20a974e-eade-11e9-a447-d8f2ca059830" \
 -d '{"token": "0Am0JpyQi8GqUKL0dZeubw=="}' \
 -plaintext localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/GetConnectionTokenInfo
```

```
{
  "creator": {
    "issuer": {
      "DID": "did:prism:issuer-1",
      "name": "Issuer 1"
    }
  }
}
```

3. As the user add connection from the token (insert `token` from step 1):
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: e20a974e-eade-11e9-a447-d8f2ca059830" \
 -d '{"token": "0Am0JpyQi8GqUKL0dZeubw=="}' \
 -plaintext  localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/AddConnectionFromToken
```

```
{
  "connection": {
    "connectionId": "c4d82cc0-6005-4d80-86fc-0d4b2fa2934a",
    "created": "1570816440092",
    "participantInfo": {
      "issuer": {
        "DID": "did:prism:issuer-1",
        "name": "Issuer 1"
      }
    }
  }
}

```

4. As the issuer query recent connections:
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: c8834532-eade-11e9-a88d-d8f2ca059830" \
 -d '{"limit": 10}' \
 -plaintext localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/GetConnectionsPaginated
```

```
{
  "connections": [
    {
      "connectionId": "c4d82cc0-6005-4d80-86fc-0d4b2fa2934a",
      "created": "1570816440092",
      "participantInfo": {
        "holder": {
          "DID": "did:prism:holder-1",
          "name": "Holder 1"
        }
      }
    }
  ]
}
```

Find the next items by paginating the request:
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: c8834532-eade-11e9-a88d-d8f2ca059830" \
 -d '{"limit": 10, "lastSeenConnectionId": "c4d82cc0-6005-4d80-86fc-0d4b2fa2934a"}' \
 -plaintext localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/GetConnectionsPaginated
```

5. As the issuer send message to the student (insert `connectionId` from step 4):
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: c8834532-eade-11e9-a88d-d8f2ca059830" \
 -d '{"connectionId": "c4d82cc0-6005-4d80-86fc-0d4b2fa2934a", "message": "SGVsbG8sIHN0dWRlbnQhCg=="}' \
 -plaintext  localhost:50051 \
 io.iohk.atala.prism.connector.ConnectorService/SendMessage
```

```
{

}
```

6. As the student query recent messages (insert `connectionId` from step 4):
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: e20a974e-eade-11e9-a447-d8f2ca059830" \
 -d '{"limit": 10}' \
 -plaintext \
 localhost:50051 io.iohk.atala.prism.connector.ConnectorService/GetMessagesPaginated
```

```
{
  "messages": [
    {
      "id": "d56728c0-6005-4d80-86fc-0d4b2fa2934a"
      "received": "1570816581675",
      "connectionId": "c4d82cc0-6005-4d80-86fc-0d4b2fa2934a",
      "message": "SGVsbG8sIHN0dWRlbnQhCg=="
    }
  ]
}
```

Paginate the items by the last seen message:
```
grpcurl -import-path protos/ -proto protos/connector_api.proto \
 -rpc-header "userId: e20a974e-eade-11e9-a447-d8f2ca059830" \
 -d '{"limit": 10, "lastSeenMessageId": "d56728c0-6005-4d80-86fc-0d4b2fa2934a"}' \
 -plaintext \
 localhost:50051 io.iohk.atala.prism.connector.ConnectorService/GetMessagesPaginated
```
