# Credential Verification Web

## Running the project

### Integration with grpc backends

First of all, ensure you have .protos compiled. For more information go to [Compile .protos section](#Compile-.protos)

### Actual instructions to run the project

See our main [README](../README.md#How-to-run) for instructions.

If needed, configure envoy proxy "listening port" at `.env.local` file.
For more information about environment variables see [Configurations](#Configurations)

## Compile .protos

All proto files (the .proto files and the ones generated by protoc) are in the proto dir, which is inside the src dir.

In order to compile the .protos you need to install
1. [protoc](https://github.com/protocolbuffers/protobuf/releases) version 3.12.4
1. [grpc-web](https://github.com/grpc/grpc-web/releases) version 1.0.7

    In MacOS and Linux, once you have downloaded the executable file, you can do the following to make it discoverable:
    #
        $ sudo mv ~/Downloads/protoc-gen-grpc-web-*-x86_64 \
          /usr/local/bin/protoc-gen-grpc-web
        $ chmod +x /usr/local/bin/protoc-gen-grpc-web
    #

Then run `./scripts/compile-protos.sh`

## Configurations

react-scripts package use internally .dotenv. For more information see [adding-custom-environment-variables](https://create-react-app.dev/docs/adding-custom-environment-variables).

Environment variables are configured in `.env` file.
For development purposes copy `.env` file to `.env.local`. This file is excluded from git and overrides `.env` for all environments except test.

### Docker build

These instructions are useful for our deploys, they may be outdated. They are not needed to run the app locally.

1. Environment variables in `.env` config file are used as default.
1. Build deployment bundle with `npm run build`
1. Build docker image `docker build .`.
1. Run container `docker run -it -p 80:HOST_PORT -e REACT_APP_GRPC_CLIENT=http://localhost:10000 --rm <image>`.

## Developer considerations

You should avoid destructuring or `...` operator with Api object in components. As I noticed, when using such features combined with `function` and `prototype` it produces to loose "this" context. 

In some components, you should also find some functions wrapped in other functions that look as unnecessary. This is a hack to preserve "this" context.

## scripts

- [compile-protos.sh](./scripts/compile-protos.sh): Compile the js bindings for the gRPC API.
- [nukestate.sh](./scripts/nukestate.sh): Used to reset the application state (to start over with a new database). This does not reset the browser's state, you must do that by deleting all the entries in its localstorage.
To run it, you must shut down the node, wallet and connector first.
*warning*: It'll `stop` and `rm` any container for which `docker ps` matches `\bpostgres\b`
