{{- if and (.Values.ingress.enabled) (not .Values.server.legacyMode) }}
apiVersion: apisix.apache.org/v2
kind: ApisixRoute
metadata:
  name: node-route
  namespace: "{{ .Release.Namespace }}"
  labels:
    {{ template "labels.common" . }}
spec:
  http:
  - name: node-rule
    match:
      hosts:
      {{- range .Values.applicationUrls }}
        - {{ . }}
      {{- end }}
      paths:
      {{- if .Values.ingress.universalResolver }}
      - /prism-node/did/*
      {{- else }}
      - /prism-node/*
      {{- end }}
    backends:
       - serviceName: node-service
         servicePort: 50053
    authentication:
      enable: true
      type: keyAuth
    plugins:
    - limit-count:
      count: 100,
      time_window: 60,
      rejected_code: 429
    - name: proxy-rewrite
      enable: true
      config:
        regex_uri: ["^/prism-node/(.*)","/$1"]
    {{ template "cors" . }}
    {{ template "consumer-restriction" . }}
{{- end -}}
