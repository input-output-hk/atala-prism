## Running

Start the database first:

```sh
docker run -it --rm -e POSTGRES_DB=atala_mirror_db -p 5434:5432 postgres:11.5
```

To create example DID (otherwise the DID will be generated automatically 
and saved in the database), run:

```sh
sbt "connectorClient/run register"
```

then update Mirror's configuration (in application.conf or env):

```sh
export ATALA_MIRROR_CONNECTOR_DID="<did form the above command>"
export ATALA_MIRROR_CONNECTOR_DID_PRIVATE_KEY="<private key form the above command>"
```

Then run Mirror GRPC server:

```sh
ATALA_MIRROR_PSQL_HOST=localhost:5434 sbt mirror/run
```

## Usage

Example request:

```
grpcurl -import-path ../prism-sdk -proto protos/mirror_api.proto \
  -plaintext localhost:50057 \
  io.iohk.atala.mirror.protos.MirrorService/CreateAccount
```

## E2E testing

### Prerequisites

* install development version of the Atala PRISM mobile app (I’ve used iOS version via TestFlight and Android Emulator)
* install `libqrencode` for QR code generation (not required, but allows to create QR  code from the shell)
* create DID (I’ve created one with `sbt "connectorClient/run register -h develop.atalaprism.io -p 50051 -u c8834532-eade-11e9-a88d-d8f2ca059830"`)
* go through the demo at https://develop.atalaprism.io/credentials to obtain credentials

### Steps

1. Configure Mirror with develop connector:
```sh
export ATALA_MIRROR_CONNECTOR_HOST="develop.atalaprism.io"
export ATALA_MIRROR_CONNECTOR_PORT=50051
export ATALA_MIRROR_CONNECTOR_DID="did:prism:635cd53a076b05cbb6d880e6c3860357927dfaef445fe196a502ae9c257d50b6"
export ATALA_MIRROR_CONNECTOR_DID_PRIVATE_KEY="BSbQDmDAukupfCpWSqDwsPaPrQWG3tV5V742It-892A="
```

2. Start Mirror:
```sh
docker run -it --rm -e POSTGRES_DB=atala_mirror_db -p 5434:5432 postgres:11.5
ATALA_MIRROR_PSQL_HOST=localhost:5434 sbt mirror/run
```

3. Create QR code form new connection token:
```sh
grpcurl -import-path ../prism-sdk -proto protos/mirror_api.proto \
  -plaintext localhost:50057 \
  io.iohk.atala.mirror.protos.MirrorService/CreateAccount | \
jq -r '.connectionToken'| tr -d '\n\t' | qrencode -t UTF8
```

4. Scan the QR code with the mobile app.

5. Wait for credential request on the mobile app (it can take a few minutes).

## Trisa
https://trisa.io/ 

We use certificates generated by https://trisacrypto.github.io/getting_started/demo/ during testing. 
Mirror uses vasp3 certificates and official client uses vasp2 certificates.

### Test Running
1. Follow instructions on https://trisacrypto.github.io/getting_started/demo/ to get trisa
   demo environment running
2. Copy `server.crt` `server.key` `trust.chain` from `trisa/artifacts/domo/vasp3/` (trisa demo environment) to
    `mirror/etc/trisa` directory
3. Edit `/etc/hosts` file, add: `172.22.0.2	vasp1` line where`172.22.0.2` is the ip address of Vasp1 running in docker
   (Vasp2 uses localhost port: `8092`)
4. Copy `server.crt` `server.key` `trust.chain` from `trisa/artifacts/domo/vasp3/` (trisa demo environment) to
   `trisa/artifacts/testnet/myOwnVasp/` (trisa demo environment)
5. Edit `/etc/hosts` file, add: `127.0.0.1	vasp3`
6. Enable trisa in mirror: `export ATALA_MIRROR_TRISA_ENABLED=true`
7. Run mirror with all the required dependencies (node, connector, database). Mirror should send message to Vasp1
8. Run official client (from trisa directory): 
   `bazel run --run_under="cd $PWD/artifacts/testnet/myOwnVasp && " //cmd/trisa -- server --config config.yaml`
9. Send transaction to official client (vasp2) to mirror: `curl -ks "https://127.0.0.1:9999/send?target=vasp3:7777"`

