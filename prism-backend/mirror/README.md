# Atala Mirror

Atala Mirror is a component helping to use PRISM identity and credentials in context of cryptocurrency transactions. Currently it allows registering PayID (currently rebranded to PayString) name, linking identity (via credentials), and registering Cardano addresses or even whole wallets. Such aggregated data can be then accessed by Virtual Asset Service Providers such as cryptocurrency exchanges.

The most obvious way to interact with Mirror is using PRISM Wallet - either Android or iOS one. Communication between the wallet and Mirror is a little bit hacky: the wallet first accesses GRPC endpoint defined in `prism-sdk/protos-src/mirror_api.proto` at port `8081` of the same host as Connector to obtain connection token and then communicates via PRISM Connector messages.

## KYC Bridge in AWS

If you want to just play with Mirror, the easiest approach is to use instance deployed in AWS from `develop` branch. PRISM wallet will connect to it by default.

## Running Mirror locally

Process of running KYC Bridge locally is quite complex:

1. You need to run PRISM Node and PRISM Connector locally

```sh
docker run -it --rm -e POSTGRES_DB=node_db -p 5432:5432 postgres:11.5
NODE_PSQL_HOST= sbt node/run
```

```sh
docker run -it --rm -e POSTGRES_DB=connector_db -p 5433:5432 postgres:11.5
CONNECTOR_PSQL_HOST=localhost:5433 sbt connector/run
```

2. Start the database:

```sh
docker run -it --rm -e POSTGRES_DB=atala_mirror_db -p 5434:5432 postgres:11.5
```

3. Ask Atala team for credentials to db sync database. Export those credentials:

```sh
export ATALA_MIRROR_DB_SYNC_HOST="host"
export ATALA_MIRROR_DB_SYNC_DATABASE="database"
export ATALA_MIRROR_DB_SYNC_USERNAME="username"
export ATALA_MIRROR_DB_SYNC_PASSWORD="password"
```

Note: if you are connecting to DB is AWS, you might want to disable SSL using:

```sh
export ATALA_MIRROR_DB_SYNC_URL="jdbc:postgresql://$ATALA_MIRROR_DB_SYNC_HOST/$ATALA_MIRROR_DB_SYNC_DATABASE?sslmode=disable"
```

Otherwise you might get `java.security.cert.CertPathValidatorException: Algorithm constraints check failed on signature algorithm: SHA1withRSA`.

4. Run Mirror GRPC server:

```sh
ATALA_MIRROR_GRPC_PORT=8081 ATALA_MIRROR_PSQL_HOST="localhost:5434" sbt mirror/run
```

5. You can start using PRISM wallet:
 - In case of Android first skip identity verification, configure backend (both Connector and KYC Bridge need to be available on network)

**Note: you'll most probably want to run both KYC Bridge and Mirror, and PRISM mobile wallets use hardcoded 8081 port to connect. You can solve that either by first running KYC Bridge during identity verification process, then stopping it and starting Mirror or by setting up Envoy to route requests based on path.**

## Fetching identity info for address

Once you successfuly obtain KYC credential, create an Mirror account (available in the PRISM Wallet as PayID account), and register your Mirror address you can query for address identity information (replace address and environment endpoint with your data):

``` sh
$ grpcurl -import-path prism-sdk/protos/src/ -proto mirror_api.proto -plaintext  -d '{"address": "addr_test1qrlxjj2szquxms2je46eqh0ydtxtms2mk92rhkc9xklmvxqpc8h8qwnecgqcm6l544k0j4tst8eu4kwfuhpqdrslfc3sjtmj6g"}' grpc-develop.atalaprism.io:8081 io.iohk.atala.mirror.protos.MirrorService/GetIdentityInfoForAddress
```

## Trisa

_Note: this section is outdated. This version of Mirror does not support up to date version of TRISA protocol._

https://trisa.io/ 

We use certificates generated by https://trisacrypto.github.io/getting_started/demo/ during testing. 
Mirror uses vasp3 certificates and official client uses vasp2 certificates.

### Test Running
1. Follow instructions on https://trisacrypto.github.io/getting_started/demo/ to get trisa
   demo environment running
2. Copy `server.crt` `server.key` `trust.chain` from `trisa/artifacts/domo/vasp3/` (trisa demo environment) to
    `mirror/etc/trisa` directory
3. Edit `/etc/hosts` file, add: `172.22.0.2	vasp1` line where`172.22.0.2` is the ip address of Vasp1 running in docker
   (Vasp2 uses localhost port: `8092`)
4. Copy `server.crt` `server.key` `trust.chain` from `trisa/artifacts/domo/vasp3/` (trisa demo environment) to
   `trisa/artifacts/testnet/myOwnVasp/` (trisa demo environment)
5. Edit `/etc/hosts` file, add: `127.0.0.1	vasp3`
6. Enable trisa in mirror: `export ATALA_MIRROR_TRISA_ENABLED=true`
7. Run mirror with all the required dependencies (node, connector, database). Mirror should send message to Vasp1
8. Run official client (from trisa directory): 
   `bazel run --run_under="cd $PWD/artifacts/testnet/myOwnVasp && " //cmd/trisa -- server --config config.yaml`
9. Send transaction to official client (vasp2) to mirror: `curl -ks "https://127.0.0.1:9999/send?target=vasp3:7777"`
