\subsection{Correctness and Security of \CUASGen}
\label{ssec:security-uas}

First, we define the \ExtractIssue, \ExtractSign, \IdentifyCred and \IdentifyUK
functions that are needed for some of the properties to be meaningful, in
\figref{fig:helper-funcs}.

\begin{figure}[ht!]
  \begin{minipage}[t]{\textwidth}
    \procedure{$\ExtractIssue(\parm,\utrans)$}{%
      \textrm{Parse \parm as $(\cdot,\cdot,\cdot,\cdot,\NIZKcrs_{\Issue},\cdot,
        \cdot,\cdot)$; $\NIZKcrs_{\Issue}$ as $(\NIZKcrs,\NIZKtrap)$; and
        \utrans as $(\Ccom,\sipk,\cred,\NIZKproof)$} \\
      \pcif \NIZKVerify(\NIZKcrs,\NIZKproof,(\Ccom,\attrs,\sipk)): 
      \pcreturn \bot \\
      (\usk,\scred,\attrs_{\scred}) \gets \NIZKExtract(\NIZKcrs,\NIZKtrap,
      (\Ccom,\attrs,\sipk),\NIZKproof) \\
      \pcreturn (\usk,\attrs,\scred,\attrs_{\scred}) \\
    }
    
    \procedure{$\ExtractSign(\parm,\oid,\siid,\sig,\yeval,\msg,\feval)$}{%
      \textrm{Parse \parm as $(\cdot,\cdot,\cdot,\cdot,\cdot,\NIZKcrs_{\Sign},
        \cdot,\cdot)$; $\NIZKcrs_{\Sign}$ as $(\NIZKcrs,\NIZKtrap)$; and
        \sig as $(\NIZKproof,\Ec)$} \\
      \textrm{Parse $\PUBOK[\oid]$ as $(\opk,\cdot)$ and let $\sipk \gets
        \PUBIK[\siid]$} \\
      \pcif \NIZKVerify(\NIZKcrs,\NIZKproof,(\msg,\feval,\yeval,\Ec,
      \sipk,\opk)): \pcreturn \bot \\
      (\usk,\scred,\attrs_{\scred},\yinsp,r) \gets \NIZKExtract(\NIZKcrs,
      \NIZKtrap, (\msg,\feval,\yeval,\Ec,\sipk,\opk),\NIZKproof) \\
      \pcreturn (\usk,\scred,\attrs_{\scred},\yinsp) \\
    }
    
    \procedure{$\IdentifyCred(\usk,\attrs_{\cred},\cred)$}{%
      \pcreturn \SBCMVerify(\ipk_{\cred},\cred,\usk,\attrs_{\cred}) \\
    }

    \procedure{$\IdentifyUK(\uid,\usk)$}{%
      \pcif \uid \in \HU: \pcreturn \usk = \UK[\uid] \\
      \pcfor \cid~\st~\CRED[\cid] = (\uid,\cdot,\cdot,\cdot,\cdot,\cdot) \\
      \pcind (\usk',\cdot,\cdot,\cdot) \gets \ExtractIssue(\parm,\trans[\cid]) \\
      \pcind \pcif \usk = \usk': \pcreturn 1 \\
      \pcreturn 0
    }
  \end{minipage}
  \label{fig:helper-funcs}
  \caption{Definition of helper functions \ExtractIssue, \ExtractSign,
    \IdentifyCred, and \IdentifyUK, for \CUASGen.}
\end{figure}

\begin{theorem}[Correctness of \CUASGen]
  \label{thm:correctness-uas}
  If the underlying schemes for vector commitments, encryption, digital
  signatures, signatures on blocks of committed messages, and NIZKs are
  correct, our generic construction \CUASGen satisfies correctness as
  defined in \defref{def:correctness-uas}.
\end{theorem}

\begin{proof}[\thmref{thm:correctness-uas}; Correctness of \CUASGen]
  \todo{XXX}
\end{proof}

\begin{theorem}[Anonymity of \CUASGen]
  \label{thm:anonymity-uas}
  If the NIZK system used for $\NIZKRel_{\Sign}$ is zero-knowledge, our
  \CUASGen construction satisfies anonymity as defined in
  \defref{def:anonymity-uas}.
\end{theorem}

\begin{proof}[\thmref{thm:anonymity-uas}; Anonymity of \CUASGen]
  In this proof, we restrict to the case in which the adversary can only make
  one query to the challenge oracle. Note however that the generalization to
  polynomially many queries given in \cite{bsz05} applies here too (with the
  corresponding security loss). Thus, proving security for one query to the
  challenge oracle is enough.

  We start from $G_0=\ExpAnonb$, and define game $G_1$ to be exactly the same
  as $G_0$, except that, within the $\Setup$ algorithm, we replace
  $\NIZKSetup^{\Sign}$ with $\NIZKSimSetup^{\Sign}$. By zero-knowledgeness,
  $G_1$ is indistinguishable from $G_0$.
  
  From $G_1$, we consider $G^0_1$, which we define to be $G_1$, for $b=0$
  (i.e., \ExpAnonz, using $\NIZKSimSetup^{\Sign}$). The challenge sent to the
  adversary is $(\csig_0,\yeval) \gets \Sign(\PRVUK[\cuid_0],\PUBOK[\oid],
  \CRED[\scid_0],\msg,\feval)$, where $\csig_0 = (\pi_0,\Ec_{\yinsp})$, with
  $\pi_0 = \NIZKProve^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},(\msg,\feval,\yeval,
  \Ec_{\yinsp},\PUBIK[\scid_0],\PUBOK[\oid]),(\PRVUK[\cuid_0],
  \CRED[\scid_0],\attrs_{\scid_0},\yinsp,r))$ and $\Ec_{\yinsp} =
  \EEnc(\PUBOK[\oid],\yinsp;r)$.
  %
  Further, we build $G_2^0$ from $G_1^0$ by simulating the proof $\pi_0$. That
  is, in $G_{2,0}$, $\csig_0 = (\pi_0^s,\Ec_{\yinsp})$, where $\pi^s_0 =
  \NIZKSim^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},\NIZKtrap,(\msg,\feval,\yeval,
  \Ec_{\yinsp},\PUBIK[\scid_0],\PUBOK[\oid]))$. By zero-knowledgeness
  of $\NIZK^{\Sign}$, $G_2^0$ is indistinguishable from $G_1^0$.

  Similarly, we consider $G_1^1$ and $G_2^1$. That is, $G_1^1$ is $G_1$
  for $b=1$, where the challenge
  sent to the adversary is $(\csig_1,\yeval) \gets \Sign(\PRVUK[\cuid_1],
  \PUBOK[\oid],\CRED[\scid_1],\msg,\feval)$, where $\csig_1 = (\pi_1,
  \Ec_{\yinsp})$, with $\pi_1 = \NIZKProve^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},
  (\msg,\feval,\yeval,\Ec_{\yinsp},\PUBIK[\scid_1],\PUBOK[\oid]),
  (\PRVUK[\cuid_1],\CRED[\scid_1],\attrs_{\scid_1},\yinsp,r'))$ and $\Ec_{\yinsp}
  = \EEnc(\PUBOK[\oid],\yinsp;r')$. As before, $G_2^1$ is built from $G_1^1$,
  simulating $\pi_1$. That is, in $G_2^1$, $\csig_1 = (\pi_1^s,\Ec_{\yinsp})$,
  where $\pi^s_1 = \NIZKSim^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},\NIZKtrap,(\msg,
  \feval,\yeval,\Ec_{\yinsp},\PUBIK[\scid_1],\PUBOK[\oid]))$. Again, by
  zero-knowledge of $\NIZK^{\Sign}$, $G_2^1$ is indistinguishable from $G_1^1$.
  Note also that $G_2^1=G_2^0$ as, in the challenge oracle used in the
  anonymity game, we restrict to $\PUBIK[\scid_0] = \PUBIK[\scid_1]$.

  Finally, consider the definition of $\AdvAnon=|\Pr\lbrack
  \ExpAnono(1^\secpar)=1\rbrack-\Pr\lbrack\ExpAnonz(1^\secpar)=1\rbrack|$. As
  argued, $G_1$ is indistinguishable from $\ExpAnonb$, thus
  $\AdvAnon \approx |\Pr\lbrack G_1^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_1^0(1^\secpar)=1\rbrack| \approx
  |\Pr\lbrack G_2^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_2^0(1^\secpar)=1\rbrack|$. Since $G_2^1=G_2^0$, it follows that
  \AdvAnon is negligible.
  %
  \qed
\end{proof}

\begin{theorem}[Issuance unforgeability of \CUASGen]
  \label{thm:issue-forge-uas}
  If the underlying NIZK used for $\NIZKRel_{\Issue}$ is simulation extractable
  and sound, then our \CUASGen construction satisfies issuance unforgeability as
  defined in \defref{def:issue-forge-uas}, except with negligible probability.
\end{theorem}

\begin{proof}[\thmref{thm:issue-forge-uas}; Issue unforgeability of \CUASGen]
  We show that the probability that \fissue outputs $0$ is negligible, as well
  as the probability that the extracted \usk is not the one that was used to
  request some of the credentials employed to obtain the credential specified by
  the adversary.
  %
  For this purpose, we define two games, $G_0=\ExpForgeIssue$, and $G_1$, which
  is exactly the same, but where, within the \Setup algorithm, we replace
  $\NIZKSetup^{\Issue}$ with $\NIZKSimSetup^{\Issue}$. As per the definition of
  \NIZK in \appref{sapp:nizk}, both games are indistinguishable.

  Now, observe that the adversary is required to output a credential
  identifier for which associated entries in \trans and \CRED exist; moreover,
  if such a credential was produced by an issuer, we must have access to those
  entries, as issuers are assumed to be honest.
  %
  Then, given that $\NIZKRel_{\Issue}$ is knowledge extractable (which is implied
  by simulation-extractability), in game $G_1$
  we can apply the \NIZKExtract function, which produces a tuple $(\usk,\scred,
  \attrs_{\scred})$ from $\utrans = (\Ccom,\attrs,\sipk,\cred,\NIZKproof)$.
  %
  Since \NIZKproof is accepted by \ExtractIssue, from the soundness of \NIZK, we
  know that all $\cred \in \scred$ are valid signatures over \usk, and their
  respective $\attrs_{\cred}$. Thus, \IdentifyCred returns $1$ for all $(\usk,
  \attrs_{\cred},\cred)$ tuples. That is, all the credentials in \scred given
  to \fissue belong to the same user, who is the owner of \usk.
  %
  Finally, since issuers are honest, we know that $\ATTR[\cid] = \attrs$ and,
  consequently, $\fissue(\usk,\scred,\ATTR[\cid]) = \fissue(\usk,\scred,\attrs)
  = 1$, due to the soundness of \NIZK.
  %
  \qed
\end{proof}

\begin{theorem}[Signing unforgeability of \CUASGen]
  \label{thm:sign-forge-uas}
  If the underlying NIZK scheme for $\NIZKRel_{\Sign}$ is zero-knowledge, sound,
  and simulation extractable, the NIZK scheme for $\NIZKRel_{\Inspect}$ is sound
  and simulation extractable, and \SBCM is one-more unforgeable, then our
  \CUASGen construction satisfies signing unforgeability as defined in
  \defref{def:sign-forge-uas}, except with negligible probability.
\end{theorem}

\begin{proof}[\thmref{thm:sign-forge-uas}; Sign unforgeability of \CUASGen]
  As for \thmref{thm:issue-forge-uas}, we define two games, $G_0=\ExpForgeSign$,
  and $G_1$, which is exactly the same but where, within the \Setup algorithm,
  we replace $\NIZKSetup^{\Sign}$ with $\NIZKSimSetup^{\Sign}$. After
  zero-knowledgeness of $\NIZK^{\Sign}$, both games are indistinguishable.

  From $G_1$, and in order to define the winning conditions for the adversary
  in the signing unforgeability game, consider the following events:

  \begin{description}
  \item[$V$.] Where $V = \Verify(\opk,\sipk,\sig,\yeval,\msg,\feval) = 1$.
  \item[$J$.] Where $J = \Judge(\opk,\sipk,\yinsp,\iproof,\sig,\yeval,\msg,
    \feval) = 0$.
  \item[$L$.] Where $L = (\msg,\feval,\yeval,\Ec,\sipk,\opk) \in
    \NIZKLang^{\Sign}$.    
  \item[$I$.] Where $I = \exists \cred \in \scred~\st~\IdentifyCred(\usk,
    \attrs_{\cred},\msg) = 0$.
  \end{description}

  $\adv$ wins if $V \land (J \lor I) = (\overline{L} \land V \land (J \lor I))
  \lor (L \land V \land (J \lor I))$.
  %
  $V$ implies that $(\msg,\feval,\yeval,\Ec,\sipk,\opk) \in \NIZKRel^{\Sign}$.
  Thus, after soundness of $\NIZK^{\Sign}$, the probability of $\overline{L}
  \land V \land (J \lor I)$ is negligible in the security parameter.
  %
  For $(L \land V \land (J \lor I))$ to be satisfied, there are three cases:
  \begin{enumerate}
  \item $L \land V \land J \land \overline{I}$. The game returns 1 in step 6.
  \item $L \land V \land J \land I$.  The game returns 1 in step 6.
  \item $L \land V \land \overline{J} \land I$. The game returns 1 in step 10. 
  \end{enumerate}

  In case 1, $L \land V$ implies that $(\msg,\feval,\yeval,\Ec,\sipk,\opk) \in
  \NIZKRel^{\Sign}$. More concretely, soundness of $NIZK^{\Sign}$ implies that
  $\Ec = \EEnc(\opk,\yinsp;r)$, for $\yinsp$ and $r$ known to the signer. Since
  $(\yinsp,\iproof)$ is generated honestly by the challenger from
  $(\opk,\sipk,\sig = (\NIZKproof_{\Sign},\Ec),\yeval,\msg)$, correctness of
  public key encryption implies that $\EDec(\osk,\Ec) = \yinsp$. Consequently,
  the probability of $L \land V \land J \land \overline{I}$ = 0, as \Judge
  checks precisely that \Ec is a correct encryption of \yinsp under \opk.

  The analysis for case 2 is the same as for case 1.

  For case 3, $(\msg,\feval,\yeval,\Ec,\sipk,\opk) \in \NIZKRel^{\Sign}$,
  $\Judge(\opk,\sipk,\yinsp,\iproof,\sig,\yeval,\msg,\feval)
  = 1$, but there exists some credential \cred for which $\IdentifyCred(\usk,
  \attrs_{\cred},\msg)=0$. Note that \usk, $\attrs_{\cred}$ and \cred (for all
  $\cred \in \scred$) are output by \ExtractSign. Thus, after the
  simulation-extractability property and soundness of $\NIZK^{\Sign}$, $(\msg,
  \feval,\yeval,\Ec,\sipk,\opk) \in \NIZKRel^{\Sign}$, which more concretely
  means that, for all $\cred \in \scred$, $\SBCMVerify(\ipk_{\cred},\cred,\usk,
  \attrs_{\cred}) = 1 = \IdentifyCred(\usk,\attrs_{\cred},\cred)$. The
  probability of case 3 is therefore $0$.
  %
  Moreover, since \SBCMVerify returns $1$ for all $\cred \in \scred$, it must
  be that all of them were obtained via queries to the \ISSUE or \OBTISS
  oracles. Otherwise, if there exists some \cred that was not obtained via
  a call to these oracles, the tuple $(\usk, \attrs_{\cred}, \cred)$ constitutes
  a forgery of \SBCM.

  Cases 1, 2 and 3 above account for winning conditions at steps 6 and 10.
  % 
  Additionally, $\adv$ wins at step 8 if $\feval(\usk,\scred,\msg) \neq \yeval$,
  where \yeval is the value output by the adversary in step 2. However, since
  $\Verify(\opk,\sipk,\sig,\yeval,\msg,\feval) = 1$, soundness of $NIZK^{\Sign}$
  implies that this has negligible probability.
  %
  Similarly, $\adv$ wins at step 9 if (1) $\finsp(\yeval,\usk,\scred,\msg) \neq
  \yinsp$, where \yinsp is the value output by \Inspect at line 5; or if (2)
  $\yinsp \neq \yinsp'$, where $\yinsp'$ is the value extracted by \ExtractSign
  at step 7. For (1), soundness of $\NIZK^{\Sign}$ ensures that \yinsp is the
  correct evaluation of \finsp, whereas soundness of $\NIZK^{\Inspect}$ and
  correctness of the public key encryption ensure that this is also the value
  output by \Inspect. Thus, the probability of $\adv$ winning the game because
  of (1) is negligible. Finally, for (2), simulation-extractability of
  $\NIZK^{\Inspect}$ and correctness of the public key encryption ensure that
  the $\yinsp'$ value extracted by \NIZKExtract matches the value produced by
  \Inspect.

  The only remaining option for $\adv$ to win is via winning condition at line
  11. At that point, we already know that all credentials are bound to the same
  user key (otherwise, the adversary wins at line 10). If this key is not
  associated to any known user, this means that there is no matching $\langle
  \Obtain,\Issue\rangle$ transcript for a credential over $\usk$ --i.e., the
  honest issuer did not issue any credential to \usk. But, as \sig must have
  been produced with at least one credential (extracted at step 7), then this
  credential is a forgery, breaking security against one-more forgery of the
  \SBCM scheme.  
  %
  \qed
\end{proof}

\begin{theorem}[Non-frameability of \CUASGen]
  \label{thm:frame-uas}
  If the underlying scheme for $\NIZK^{\Issue}$ is zero-knowledge, the scheme
  for $\NIZK^{\Sign}$ is zero-knowledge, sound and simulation-extractable, the
  scheme for $\NIZK^{\Open}$ is zero-knowledge and sound, and the commitment
  scheme is hiding, then our \CUASGen construction satisfies non-frameability as
  defined in \defref{def:frame-uas}, except with negligible probability.
\end{theorem}

\begin{proof}[\thmref{thm:frame-uas}; Non-frameability of \CUASGen]
  First, note that the adversary wins if it produces a signature that traces to
  an honest user (which, in our case, is tested by checking whether the
  extracted \usk belongs ot an honest user); and, in addition, either (1) the
  signature was not produced via a call to the \SIGN oracle, or (2) the opening
  value output by the adversary and accepted by \Judge, does not match the
  extracted one (i.e., the one used as witness to $\NIZKRel^{\Sign}$). Note that
  the probability of (2) is negligible due to soundness of $\NIZK^{\Sign}$ and
  $\NIZK^{\Open}$, given that \Verify and \Judge accept the signature and
  opening proof.
  
  Next we prove that, given an adversary $\adv$ against non-frameability of
  \CUASGen, under condition (1) above, we can build an adversary \advB that
  breaks the hiding property of the underlying commitment scheme, with
  non-negligible probability.

  We start from $G_0=\ExpNonframe$. $\adv$ makes queries to the oracles in
  \Oframe.

  For $G_1$, within \Setup, we replace the \Setup algorithms for the three
  NIZKs (\Issue, \Sign and \Inspect) with their corresponding \SimSetup
  variants. Consequently, the corresponding queries to \Prove are also
  simulated via the simulator. By the zero-knowledge property of the NIZK
  systems, $G_1$ is indistinguishable from $G_0$.
  
  We build adversary \advB against hiding of commitments from $G_1$ against
  non-frameability. In the hiding game (see \figref{fig:com-games}), \advB first
  picks two messages $\msg_0$ and $\msg_1$, and then receives a commitment \Ccom
  of $\msg_b$. Let \advB pick both $\msg_0$ and $\msg_1$ from \AttrSpace. Then,
  \advB initializes $G_1$ for $\adv$ against non-frameability, and randomly
  picks a number $u \getr [1,q]$, where $q$ can be as large as \advB wants, but
  will be the maximum number of honest users to let $\adv$ add to the game.
  Then, when $\adv$ asks to create the $u$-th user, \advB ignores the call to
  \UKeyGen. For every call that $\adv$ makes to the \OBTAIN oracle associated to
  the $u$-th user, \advB uses the commitment \Ccom received as challenge in its
  game against the hiding property of commmitments, and uses it as commitment to
  the $u$-th user's \usk. \advB then simulates all the NIZK proofs associated to
  the $u$-th user, in calls to \OBTAIN, \SIGN and \INSPECT. Again, due to the
  zero-knowledge property of the associated NIZK systems, the outputs of the
  modified oracles are indistinguishable from the original outputs (as \Ccom
  is a valid commitment of a user secret key). Eventually, $\adv$ outputs a
  $(\sig,\yeval,\msg,\feval,\yinsp,\iproof)$ tuple that is accepted by \Verify
  and \Judge. Due to simulation extractability of $NIZK^{\Sign}$, \ExtractSign
  must be able to produce a $(\usk,\scred,\attrs_{\scred},\yinsp')$ tuple. Since
  $\adv$ wins the non-frameability game, with probability $1/q$,
  the \usk value belongs to the $u$-th honest user, so it must be equal to
  either $\msg_0$ or $\msg_1$; \advB responds accordingly to its challenge in
  the game for the hiding property of the commmitment scheme. By assumption,
  \advB wins with non-negligible probability.
  %
  \qed
\end{proof}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "uas"
%%% End:
