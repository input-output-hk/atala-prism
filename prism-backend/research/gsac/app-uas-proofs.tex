\section{Correctness and Security Proofs for \CUASGen}
\label{app:uas-proofs}

First, we define the \SimSetup, \ExtractIssue, \ExtractSign, \IdentifyCred and
\IdentifySig functions that are needed for some of the properties to be
meaningful, in \figref{fig:helper-funcs}.

\begin{figure}[ht!]
  \scalebox{0.9}{
    \begin{minipage}[t]{\textwidth}
      \procedure{$\SimSetup(1^\secpar)$}{%
        \textrm{Parse}~\secpar~\textrm{as}~(\Csecpar,\NIZKsecpar,\SBCMsecpar,
        \Esecpar). \\
        \Cparm \gets \CSetup(\Csecpar), \SBCMparm \gets  \SBCMSetup(\SBCMsecpar) \\
        \Sparm \gets \SSetup(\Ssecpar), \Eparm \gets \ESetup(\Esecpar) \\
        (\NIZKcrs_{\Issue},\trap_{\Issue}) \gets
        \NIZKSimSetup^{\NIZKRel_{\Issue}}(\NIZKsecpar) \\
        (\NIZKcrs_{\Sign},\trap_{\Sign}) \gets
        \NIZKSimSetup^{\NIZKRel_{\Sign}}(\NIZKsecpar) \\
        (\NIZKcrs_{\Open},\trap_{\Open}) \gets
        \NIZKSimSetup^{\NIZKRel_{\Open}}(\NIZKsecpar) \\
        \pcreturn ((\Cparm,\SBCMparm,\Sparm,\Eparm,\NIZKcrs_{\Issue},
        \NIZKcrs_{\Sign},\NIZKcrs_{\Open},\AttrSpace), \\
        \pcind (\trap_{\Issue},\trap_{\Sign},\trap_{\Open})) \\
      }
      
      \procedure{$\ExtractIssue(\parm,\trap,\utrans)$}{%
        \textrm{Parse \parm as $(\cdot,\cdot,\cdot,\cdot,\NIZKcrs_{\Issue},\cdot,
          \cdot,\cdot)$} \\
        \textrm{Parse \trap as $(\trap_{\Issue},\cdot,\cdot)$, and
          \utrans as $(\Ccom,\sipk,\cred,\NIZKproof)$} \\
        \pcif \NIZKVerify^{\NIZKRel_{\Issue}}(\NIZKcrs_{\Issue},
        \NIZKproof,(\Ccom,\attrs,\sipk)): \pcreturn \bot \\
        (\usk,\scred,\attrs_{\scred}) \gets
        \NIZKExtract^{\NIZKRel_{\Issue}}(\NIZKcrs_{\Issue},
        \trap_{\Issue},
        (\Ccom,\attrs,\sipk),\NIZKproof) \\
        \pcreturn (\usk,\attrs,\scred,\attrs_{\scred}) \\
      }
      
      \procedure{$\ExtractSign(\parm,\trap,\oid,\siid,\sig,\yeval,\msg,\feval)$}{%
        \textrm{Parse \parm as $(\cdot,\cdot,\cdot,\cdot,\cdot,\NIZKcrs_{\Sign},
          \cdot)$} \\
        \textrm{Parse \trap as $(\cdot,\trap_{\Sign},\cdot)$, and
          \sig as $(\NIZKproof,\ceval,\cinsp)$} \\
        \textrm{Parse $\PUBOK[\oid]$ as $(\opk,\cdot)$ and let $\sipk \gets
          \PUBIK[\siid]$} \\
        \pcif \NIZKVerify^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},\NIZKproof,
        (\msg,\feval,\yeval,\Ec,\sipk,\opk)): \pcreturn \bot \\
        (\usk,\scred,\attrs_{\scred},\yinsp,r) \gets
        \NIZKExtract^{\NIZKRel_{\Sign}}(\NIZKcrs^{\NIZKRel_{\Sign}},
        \NIZKtrap_{\Sign},
        (\msg,\feval,\yeval^0,\ceval,\cinsp,\sipk,\opk,\widetilde{\Eek}),
        \NIZKproof) \\
        \pcreturn (\usk,\scred,\attrs_{\scred},\yeval^1,\yinsp) \\
      }
      
      % \procedure{$\IdentifyCred(\parm,\trap,\usk,\attrs_{\cred},\cred)$}{%
      %   \pcreturn \SBCMVerify(\ipk_{\cred},\cred,\usk,\attrs_{\cred}) \\
      % }

      \procedure{$\IdentifyCred(\parm,\trap,\usk,\attrs_{\cred},\cred,\ipk)$}{%
        \pcreturn \SBCMVerify(\ipk,\cred,\usk,\attrs_{\cred}) \\
      }      

      \procedure{$\IdentifySig(\parm,\trap,\usk,\scred,\Sig)$}{%
        \pcif \uid \in \HU: \pcreturn \usk = \UK[\uid] \\
        \pcfor \cid~\suchthat~\CRED[\cid] = (\uid,\cdot,\cdot,\cdot,\cdot,\cdot) \\
        \pcind (\usk',\cdot,\cdot,\cdot) \gets \ExtractIssue(\parm,\trap,\trans[\cid]) \\
        \pcind \pcif \usk = \usk': \pcreturn 1 \\
        \pcreturn 0
      }

      % \procedure{$\IdentifySig(\parm,\trap,\uid,\usk)$}{%
      %   \pcif \uid \in \HU: \pcreturn \usk = \UK[\uid] \\
      %   \pcfor \cid~\suchthat~\CRED[\cid] = (\uid,\cdot,\cdot,\cdot,\cdot,\cdot) \\
      %   \pcind (\usk',\cdot,\cdot,\cdot) \gets \ExtractIssue(\parm,\trap,\trans[\cid]) \\
      %   \pcind \pcif \usk = \usk': \pcreturn 1 \\
      %   \pcreturn 0
      % }
      
    \end{minipage}
  }
  \label{fig:helper-funcs}
  \caption{Definition of helper functions \ExtractIssue, \ExtractSign,
    \IdentifyCred, and \IdentifySig, for \CUASGen.}
\end{figure}

\subsection{Correctness}

\begin{proof}[\thmref{thm:correctness-uas}; Correctness of \CUASGen]
  By correctness of \SBCM and the NIZK for $\NIZKRel_{\Sign}$, the signature
  produced at line 5 of \ExpCorrect is accepted at line 6 by \Verify.
  Moreover, all the credentials employed to honestly produce the signature,
  identified with \scid, meet their respective issuance policies due to
  correctness of the NIZK for $\NIZKRel_{\Issue}$, so no $\fissue^\cid$ check
  returns $0$ at line 9. Similarly, as $\feval \in \famfeval$ is checked at
  line 3, and due to correctness of the NIZK for $\NIZKRel_{\Sign}$, the
  output of \feval matches $\yeval^0$ at line $11$, which must have been
  computed over $\usk=\UK[\uid]$, as in line $10$, due to correctness of the
  commitment scheme. Finally, correctness of the NIZKs for $\NIZKRel_{\Sign}$
  and $\NIZKRel_{\Open}$, and correctness of the encryption scheme, ensure that
  \Judge accepts the proof produced by \Open, and \yinsp is the correct value
  for the chosen $\finsp^{\oid}$.
\end{proof}

\subsection{Issuance Anonymity}

\begin{proof}[\thmref{thm:issue-anonymity-uas}; Issuance anonymity of \CUASGen]
  We prove the special case in which the adversary makes only one query to the
  \OBTCHALb oracle. The generalization to polynomially many queries follows from
  a standard hybrid argument.

  Let $G_0=\ExpIssAnonb(1^\secpar)$. We define $G_1$ by replacing the calls to
  \NIZKSetup in $G_0$, for the $\NIZK^{\Issue}$ and $\NIZK^{\Sign}$ systems by
  calls to their corresponding \NIZKSimSetup. By zero-knowledgeness of the
  NIZKs, both games are indistinguishable.

  Next, we simulate the NIZK proofs produced by \Obtain within the \OBTCHALb
  oracle and, consequently, the NIZK proofs produced by \Sign in \SIGN for
  signatures from the challenge user and credentials. Then, we show that the
  adversary cannot distinguish executions for $b=0$ from executions for $b=1$,
  except with negligible probabability.
  
  More concretely, on the one hand, let $G_1^0$ to be $G_1$, conditioned on
  $b=0$. Concretely, the proofs sent by the challenge user $\cuid_0$ to the
  adversarial issuer are of
  the form $\pi^*_0 =\NIZKProve^{\NIZKRel_{\Issue}}(\NIZKcrs_{\Issue},(\UK[\cuid_0],
  \CCRED[\cscid_0],\ATTR[\cscid_0],r),(\Ccom,\attrs,\PUBIK[\cscid_0]))$. The
  NIZK proofs included in the signatures produced by $\cuid_0$ are defined
  correspondingly, but for $\NIZK^{\NIZKRel_{\Sign}}$. From $G_1^0$, we define
  $G_2^0$, but instead of using \NIZKProve, we use \NIZKSim (for both \Issue
  and \Sign). That is, the proofs for credential requests are generated as
  $\pi^s_0 =\NIZKSim^{\NIZKRel_{\Issue}}(\NIZKcrs_{\Issue},\tau,(\Ccom,\attrs,
  \PUBIK[\cscid_0]))$. By zero-knowledge of the NIZK systems for \Issue and
  \Sign, $G_2^0$ is indistinguishable from $G_1^0$.

  On the other hand, following the same process for $G_1^1$ and $G_2^1$.
  Concretely, for the case of the proofs at issuance time, they are of the
  shape $\pi^s_1 =\NIZKSim^{\NIZKRel_{\Issue}}(\NIZKcrs_{\Issue},\tau,(\Ccom,\attrs,
  \PUBIK[\cscid_1]))$. Note first that $\PUBIK[\cscid_1] = \PUBIK[\cscid_0]$,
  by definition of the \OBTCHALb oracle. Hence, the produced proofs are exactly
  the same independently on the value of the bit $b$.

  Thus, $\AdvIssAnon=|\Pr\lbrack
  \ExpIssAnono(1^\secpar)=1\rbrack-\Pr\lbrack\ExpIssAnonz(1^\secpar)=1\rbrack|$.
  As argued, $G_1$ is indistinguishable from $\ExpIssAnonb$, so
  $\AdvIssAnon \approx |\Pr\lbrack G_1^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_1^0(1^\secpar)=1\rbrack| \approx
  |\Pr\lbrack G_2^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_2^0(1^\secpar)=1\rbrack|$. Since $G_2^1=G_2^0$, it follows that
  \AdvIssAnon is negligible.
  
\end{proof}

\subsection{Signature Anonymity}

\begin{proof}[\thmref{thm:sign-anonymity-uas}; Signature anonymity of \CUASGen]

  In this proof, we restrict to the case in which the adversary can only make
  one query to the challenge oracle. Note however that the generalization to
  polynomially many queries given in \cite{bsz05} applies here too (with the
  corresponding security loss). Thus, proving security for one query to the
  challenge oracle is enough.

  We start from $G_0=\ExpSigAnonb$.  %
  From $G_0$, we consider $G^0_0 = \ExpSigAnonz$. The challenge sent to the
  adversary is $(\csig_0,\yeval) \gets \Sign(\PRVUK[\cuid_0],\PUBOK[\oid],
  \CRED[\scid_0],\msg,\feval)$, where $\csig_0 = (\pi_0,\Ec_{\yinsp})$, with
  $\pi_0 = \NIZKProve^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},(\msg,\feval,\yeval,
  \ceval,\cinsp,\PUBIK[\scid_0],\widetilde{\Eek},\PUBOK[\oid]),(\PRVUK[\cuid_0],
  \CRED[\scid_0],\attrs_{\scid_0},\yeval^1,\yinsp,r,r'))$, $\ceval = \EEnc
  (\widetilde{\Eek},\yeval^1;r)$, and $\cinsp = \EEnc(\PUBOK[\oid],\yinsp;r')$.
  % 
  Further, we build $G_1^0$ from $G_0^0$ by simulating the proof $\pi_0$. That
  is, in $G_1^0$, $\csig_0 = (\pi_0^s,\ceval,\cinsp)$, where $\pi^s_0 =
  \NIZKSim^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},\NIZKtrap,(\msg,\feval,\yeval,
  \ceval,\cinsp,\PUBIK[\scid_0],\PUBOK[\oid]))$. By zero-knowledgeness
  of $\NIZK^{\Sign}$, $G_1^0$ is indistinguishable from $G_0^0$.

  Similarly, we consider $G_0^1$ and $G_1^1$. That is, $G_0^1 = \ExpSigAnono$,
  where the challenge
  sent to the adversary is $(\csig_1,\yeval) \gets \Sign(\PRVUK[\cuid_1],
  \PUBOK[\oid],\CRED[\scid_1],\msg,\feval)$, where $\csig_1 = (\pi_1,\ceval,
  \cinsp)$, with $\pi_1 = \NIZKProve^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},
  (\msg,\feval,\yeval,\ceval,\cinsp,\PUBIK[\scid_1],\widetilde{\Eek},
  \PUBOK[\oid]),(\PRVUK[\cuid_1],\CRED[\scid_1],\attrs_{\scid_1},\yeval^1,
  \yinsp,r,r'))$, $\ceval = \EEnc(\widetilde{\Eek},\yeval^1;r)$, and
  $\cinsp = \EEnc(\PUBOK[\oid],\yinsp;r')$. As before, build $G_1^1$ from
  $G_0^1$, simulating $\pi_1$. That is, in $G_1^1$, $\csig_1 = (\pi_1^s,\ceval,
  \cinsp)$, where $\pi^s_1 = \NIZKSim^{\NIZKRel_{\Sign}}(\NIZKcrs_{\Sign},
  \NIZKtrap,(\msg,\feval,\yeval,\ceval,\cinsp,\PUBIK[\scid_1],\widetilde{\Eek},
  \PUBOK[\oid]))$. Again, by zero-knowledge of $\NIZK^{\Sign}$, $G_1^1$ is
  indistinguishable from $G_0^1$. Note also that $G_1^1$ and $G_1^0$ are
  indistinguishable, due to the IND-CCA property of the encryption scheme
  (so, the \ceval values in $\csig_0$ and $\csig_1$ are indistinguishable),
  in the  challenge oracle used in the anonymity game, we restrict to
  $\PUBIK[\scid_0] = \PUBIK[\scid_1]$, and the respective \cinsp values encrypt
  the same \yinsp value (and, otherwise, \adv~is not allowed to open it).

  Finally, consider the definition of $\AdvSigAnon=|\Pr\lbrack
  \ExpSigAnono(1^\secpar)=1\rbrack-\Pr\lbrack\ExpSigAnonz(1^\secpar)=1\rbrack|
  = |\Pr\lbrack G_0^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_0^0(1^\secpar)=1\rbrack| \approx
  |\Pr\lbrack G_1^1(1^\secpar)=1\rbrack-\Pr\lbrack
  G_1^0(1^\secpar)=1\rbrack|$, which is negligible.
  % 
  \qed
\end{proof}

\subsection{Issuance Unforgeability}

\begin{proof}[\thmref{thm:issue-forge-uas}; Issuance unforgeability of \CUASGen]
  We show that the probability that \fissue outputs $0$ is negligible, as well
  as the probability that the extracted \usk is not the one that was used to
  request some of the credentials employed to obtain the credential specified by
  the adversary.
  %
  For this purpose, we define two games, $G_0=\ExpForgeIssue$, and $G_1$, which
  is exactly the same, but where, within the \Setup algorithm, we replace
  $\NIZKSetup^{\Issue}$ with $\NIZKSimSetup^{\Issue}$. Due to zero-knowledgeness
  of $\NIZK^{\NIZKRel_{\Issue}}$, both games are indistinguishable.

  Now, observe that the adversary is required to output a credential
  identifier for which associated entries in \trans and \CRED exist; moreover,
  if such a credential was produced by an issuer, we must have access to those
  entries, as issuers are assumed to be honest.
  %
  Then, given that $\NIZKRel_{\Issue}$ is knowledge extractable (which is implied
  by simulation-extractability), in game $G_1$
  we can apply the \NIZKExtract function, which produces a tuple $(\usk,\scred,
  \attrs_{\scred})$ from $\utrans = (\Ccom,\attrs,\sipk,\cred,\NIZKproof)$.
  %
  Since \NIZKproof is accepted by \ExtractIssue, from the soundness of \NIZK, we
  know that all $\cred \in \scred$ are valid signatures over \usk, and their
  respective $\attrs_{\cred}$. Thus, \IdentifyCred returns $1$ for all $(\usk,
  \attrs_{\cred},\cred)$ tuples. That is, all the credentials in \scred given
  to \fissue belong to the same user, who is the owner of \usk.
  %
  Finally, since issuers are honest, we know that $\ATTR[\cid] = \attrs$ and,
  consequently, $\fissue(\usk,\scred,\ATTR[\cid]) = \fissue(\usk,\scred,\attrs)
  = 1$, due to the soundness of \NIZK.
  %
  \qed
\end{proof}

\subsection{Signature Unforgeability}

\begin{proof}[\thmref{thm:sign-forge-uas}; Signature unforgeability of \CUASGen]
  As in \thmref{thm:issue-forge-uas}, we define two games, $G_0=\ExpForgeSign$,
  and $G_1$, which is exactly the same but where, within the \Setup algorithm,
  we replace $\NIZKSetup^{\Sign}$ with $\NIZKSimSetup^{\Sign}$. After
  zero-knowledgeness of $\NIZK^{\Sign}$, both games are indistinguishable.
  %
  Next, we show that an adversary winning $G_1$ can be used to break the
  one-more unforgeability property of \SBCM.
 
  If the verification at line 4 holds, then $(\msg,\feval,\yeval,\ceval,
  \cinsp,\sipk,\opk,\widetilde{\Eek}) \in \NIZKLang^{\Sign}$. Then:
  %

  \paragraph{(a) \Judge accepts $(\yinsp,\iproof)$.} %
  Simulation extractability of $\NIZK^{\Sign}$ thus ensures that $\cinsp =
  \EEnc(\Eek,\yinsp)$, and since the $(\yinsp,\iproof)$ is generated honestly at
  line 5, then \yinsp is the correct decryption of \cinsp, and  correctness of
  $\NIZK^{\Open}$ ensures that \Judge outputs $1$ at line 6.

  \paragraph{(b) $(\yeval^0,\yeval^1)$ are the correct signature evaluation
    pair.} Also, due to simulation extractability of $\NIZK^{\Sign}$:

  \begin{itemize}
  \item $\yeval^0 = \yeval$, where $(\yeval^0,\cdot) = \feval(\usk,\scred,
    \msg)$, and $\yeval$ is as output by \adv~at step 2.    
  \item $\tyeval^1 = \yeval^1$, where $(\cdot,\yeval^1) = \feval(\usk,\scred,
    \msg)$, and $\tyeval^1$ is as extracted by \ExtractSign at line 7.
  \end{itemize}

  Thus, the probability of \adv~winning at line 9 is $0$.

  \paragraph{(c) The output of \finsp matches the output of \Open.} %
  After (a), the \yinsp value output by \Open is the correct decryption of
  \cinsp. After (b), the $(\yeval^0=\yeval,\yeval^1)$ values output by
  \ExtractSign match the evaluation of \feval. Thus, simulation extractability
  of $\NIZK^{\Sign}$ ensures that $\finsp((\yeval^0,\yeval^1),\usk,\scred,\msg)
  = \yinsp$ and, also, that \yinsp matches the $\yinsp'$ value extracted by
  \ExtractSign. Thus, the probability of \adv~winning at line 10 is $0$.

  \paragraph{(d) All {\cred}s are bound to the same \usk.} %
  $\NIZKRel^{\Sign}$ includes a condition that $\forall \cred \in \scred,
  \SBCMVerify(\ipk_{\cred},\cred,\usk,\attrs_{\cred}) = 1$. Thus, simulation
  extractability of $\NIZK^{\Sign}$ and correctness of \SBCM, ensure that all
  credentials involved in the signature contain \usk as their user key (first)
  attribute. Consequently, \IdentifyCred returns $1$ for all the involved
  credentials, and the probability of \adv~winning at line 11 is $0$.

  \paragraph{(e) \usk must belong to a known user.} %
  The only remaining option for $\adv$ to win is via winning condition at line
  12, meaning that \IdentifySig fails to find an honest or corrupt users with
  a \usk matching the one used to request the credentials used to produce the
  signature output by \adv. However, at line 12, we already know that all
  credentials are valid signatures by the issuer and that, also, all are bound
  to the same user key. If this key is not associated to any known user, this
  means that there is no matching $\langle\Obtain,\Issue\rangle$ transcript for
  a credential over \usk --i.e., the honest issuer did not issue any credential
  to \usk. But, as \sig must have been produced with at least one credential
  (extracted at step 7), then this credential is a forgery, breaking security
  against one-more forgery of the \SBCM scheme.
  %
  \qed
\end{proof}

\subsection{Non-Frameability}

\begin{proof}[\thmref{thm:frame-uas}; Non-frameability of \CUASGen]

  % We prove that, if the NIZK system used for $\NIZKRel_{\Sign}$ and
  % $\NIZKRel_{\Open}$ is zero-knowledge and simulation-extractable, and \SBCM is
  % blind, then our \CUASGen construction is secure.

  First, suppose that the \Sig that \adv~outputs at line 2 exists in
  \SIG, for some \uid. Then, Given that the signature is accepted by \Verify at
  line 3, and after simulation extractability of $\NIZK^{\Sign}$, $\yeval =
  \yeval^0$, and $\tyeval^1 = \yeval^1$. Similarly, since the $(\yinsp,\iproof)$
  pair output by \adv~is accepted by \Judge, simulation extractability of
  $\NIZK^{\Sign}$ and $\NIZK^{\Open}$ implies that both checks at lines 7 and 8
  pass. Hence, the probability that the adversary wins at either lines 7 or 8 is
  negligible, after simulation extractability of $\NIZK^{\Sign}$ and
  $\NIZK^{\Open}$.

  Next, suppose that the \Sig output by \adv~at line 2 does not exist in \SIG.
  We prove that zero-knowledge and simulation extractability of
  $\NIZKRel_{\Sign}$, and blindness of \SBCM, ensure that this only happens with
  negligible probability.
  The crucial observation is that, as in \cite{cl06} \CUASGen's \Sign algorithm
  produces a signature of knowledge for the relation defined by
  $\NIZKRel^{\Sign}$. That is, given $(x,w) \in \NIZKRel^{\Sign}$, one can
  compare $x$ and $w$ to the public and private key of a signature algorithm,
  respectively. In $\NIZKRel^{\Sign}$, $(\usk,\scred,\attrs_{\scred},\yeval^1,
  \yinsp,r,r')$ is the private key ($w$), and $(\msg,\feval,\yeval^0,\ceval,
  \cinsp,\sipk_{\scred},\Eek,\widetilde{\Eek})$ is the public key ($x$).
  %
  From this, we prove that an adversary has only negligible probability to forge
  a signature as originating from an honest user without calling the \SIGN
  oracle. The strategy is similar to that in \cite[Theorem 2.1]{cl06}.

  Consider game $G_1$, which is equivalent to $G_0 = \ExpNonframe$, except that
  in the \Sign function within the \SIGN oracle, we simulate the NIZK proof.
  After the zero-knowledge property of $\NIZK^{\NIZKRel_{\Sign}}$, $G_1$ is
  indistinguishable from $G_0$. Now, in $G_1$, simulation extractability of
  $\NIZK^{\NIZKRel_{\Sign}}$ ensures that \ExtractSign must output a valid
  witness for $(\msg,\feval,\yeval^0,\ceval,\cinsp,\sipk_{\scred},\Eek,
  \widetilde{\Eek})$. Note that this witness must include some \usk which,
  for \adv~to win the game, must belong to an honest user. However, since the
  user (whichever it is) has not been corrupted, its \usk has not been leaked
  to \adv~via corruption queries (nor via \SIGN queries, where the proof of
  knowledge within \Sign is now simulated). Moreover, blindness of \SBCM ensures
  that the issuer (who is potentially corrupt), did not learn \usk either during
  calls to \OBTAIN. Thus, the probability that $\UK[\uid] = \usk$ for $\uid \in
  \HU$ and \Sig produced by the adversary, is negligible.
  %
  \qed
\end{proof}


%%% Local Variables:
%%% mode: latex
%%% TeX-master: "uas-paper"
%%% End:
