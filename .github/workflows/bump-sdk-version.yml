# `on repository_dispatch` means that the job gets triggered by external events.
# In our case it gets triggered by master or tags pushes to PRISM SDK repository.
on:
  repository_dispatch:
    types: [bump-sdk-version]

jobs:
  create-pull-request:
    runs-on: ubuntu-20.04
    steps:
      - name: Checkout the repo
        uses: actions/checkout@v2
      - name: Upgrade SDK version
        run: |
          SDK_VERSION="${{ github.event.client_payload.sdk_version }}"
          sed -i -E "s/val prismSdk = \"[^\"]+\"/val prismSdk = \"${SDK_VERSION}\"/g" \
            prism-backend/project/Dependencies.scala
      - uses: crazy-max/ghaction-import-gpg@v3
        with:
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          git-user-signingkey: true
          git-commit-gpgsign: true
      - name: Create release branch if required
        if: ${{ github.event.client_payload.prism_pr_branch }} != master
        uses: peterjgrainger/action-create-branch@v2.0.1
        env:
          GITHUB_TOKEN: ${{ secrets.ATALA_GITHUB_TOKEN }}
        with:
          branch: ${{ github.event.client_payload.prism_pr_branch }}
      - name: Create prism-backend pull request
        uses: peter-evans/create-pull-request@v3
        with:
          token: ${{ secrets.ATALA_GITHUB_TOKEN }}
          committer: Atala Dev <atala.dev@iohk.io>
          base: ${{ github.event.client_payload.prism_pr_branch }}
          branch: "bump-sdk-version-${{ github.event.client_payload.sdk_version }}"
          delete-branch: true
          commit-message: Bump SDK version to ${{ github.event.client_payload.sdk_version }}
          title: Bump SDK version to ${{ github.event.client_payload.sdk_version }}
